#! /usr/bin/env python

"""\
%prog <param1,param2,param3> [<ipolfile>=ipol.dat]

%prog PARAMFILE [<ipolfile>=ipol.dat]

Write out interpolated histograms at a given parameter point.

"""

import optparse, os, sys
op = optparse.OptionParser(usage=__doc__)
op.add_option("--prefix", "--output", dest="OUTPUT", default="predictions", help="Prefix for outputs (default: %default)")
op.add_option("--wfile", dest="WFILE", default=None, help="Path to a weight file, used to restrict output to a subset of histograms (default: %default)")
op.add_option("-v", "--debug", dest="DEBUG", action="store_true", default=False, help="Turn on some debug messages")
op.add_option("-q", "--quiet", dest="QUIET", action="store_true", default=False, help="Turn off messages")
opts, args = op.parse_args()


try:
    import yoda
except ImportError:
    "YODA not found, exiting"
    import sys
    sys.exit(1)



## Get mandatory arguments
if len(args) < 1:
    print "Argument missing... exiting\n\n"
    op.print_usage()
    sys.exit(1)
PARAMSTR = args[0]
IFILE = "ipol.dat"
if len(args) >= 2:
    IFILE = args[1]


import professor2 as prof
if not opts.QUIET:
    print prof.logo

## Read ipol param names and histos
META, IHISTOS = prof.read_ipolhistos(IFILE)
PNAMES = META["ParamNames"].split()

## Weight file parsing
if opts.WFILE:
    matchers = prof.read_pointmatchers(opts.WFILE)
    for hn in IHISTOS.keys():
        if not any(m.match_path(hn) for m in matchers.keys()):
            del IHISTOS[hn]
    if len(IHISTOS.keys())==0:
        print "Nothing left after weight file parsing, exiting"
        sys.exit(0)

## Parse the param point argument
PARAMS = None
if os.path.exists(PARAMSTR):
    with open(args[0]) as f:
        PARAMS = [float(l.strip().split()[-1]) for l in f if not l.startswith("#")]
else:
    if "=" not in PARAMSTR:
        PARAMS = [float(x) for x in PARAMSTR.split(",")]
    else:
        pdict = dict([x.split("=", 1) for x in PARAMSTR.split(",")])
        PARAMS = [float(pdict[p]) for p in PNAMES]


## Write out ipolhistos
ofile = opts.OUTPUT + "_prediction.yoda"
scatters=[IHISTOS[k].toDataHisto(PARAMS).toScatter2D() for k in sorted(IHISTOS.keys())]
yoda.writeYODA(scatters, ofile)

if not opts.QUIET:
    print "Wrote output to", ofile
